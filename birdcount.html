<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>小鸟计数游戏 - 手机版</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background-color: #f0f0f0;
            height: 100vh;
            overflow: hidden;
            touch-action: manipulation;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: calc(100% - 120px);
            background-color: #87CEEB;
            z-index: 1;
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.95);
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
            z-index: 20;
        }
        
        .hidden {
            display: none;
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        p {
            color: #444;
            margin: 10px 0;
            font-size: 18px;
            line-height: 1.5;
        }
        
        button {
            margin-top: 20px;
            padding: 12px 30px;
            font-size: 18px;
            background-color: #fff;
            color: #000;
            border: 2px solid #000;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        button:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }
        
        #game-stats {
            position: absolute;
            bottom: 120px;
            left: 10px;
            right: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 15px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        
        #stats-column {
            display: flex;
            flex-direction: column;
            flex: 1;
        }
        
        .stat-row {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 18px;
            color: #333;
            margin-right: 5px;
            white-space: nowrap;
        }
        
        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: #000;
            min-width: 60px;
        }
        
        .buttons-row {
            display: flex;
        }
        
        .virtual-btn {
            padding: 10px 15px;
            font-size: 18px;
            background-color: white;
            color: black;
            border: 2px solid #000;
            border-radius: 8px;
            margin: 0 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            user-select: none;
            touch-action: manipulation;
        }
        
        .virtual-btn:active {
            transform: scale(0.95);
            background-color: #f0f0f0;
        }
        
        .record-badge {
            background-color: gold;
            color: #8B0000;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 10px;
            margin-top: 10px;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .level-display {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 18px;
            color: white;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 5px 15px;
            border-radius: 20px;
            z-index: 10;
        }
        
        /* 小屏手机适配 */
        @media (max-width: 480px) {
            .stat-label {
                font-size: 16px;
            }
            
            .stat-value {
                font-size: 18px;
            }
            
            .virtual-btn {
                padding: 8px 12px;
                font-size: 16px;
            }
            
            #game-stats {
                padding: 8px 10px;
                bottom: 100px;
            }
            
            canvas {
                height: calc(100% - 100px);
            }
            
            .level-display {
                font-size: 16px;
                padding: 4px 12px;
            }
        }
        
        @media (max-width: 360px) {
            .stat-label {
                font-size: 14px;
            }
            
            .stat-value {
                font-size: 16px;
            }
            
            .virtual-btn {
                padding: 6px 10px;
                font-size: 14px;
            }
            
            #game-stats {
                padding: 6px 8px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="start-screen" class="screen">
            <h1>小鸟计数游戏</h1>
            <p>游戏规则：</p>
            <p>1. 观察屏幕上的小鸟数量</p>
            <p>2. 点击"计数"按钮增加计数</p>
            <p>3. 点击"提交"按钮完成计数</p>
            <p>4. 15秒内完成计数</p>
            <button id="start-button">开始游戏</button>
        </div>
        
        <div id="win-screen" class="screen hidden">
            <h1>游戏胜利！</h1>
            <p id="win-message"></p>
            <button id="next-level-button">下一关</button>
        </div>
        
        <div id="lose-screen" class="screen hidden">
            <h1>游戏结束！</h1>
            <p id="lose-message"></p>
            <p id="record-message"></p>
            <button id="restart-button">重新开始</button>
        </div>
        
        <div id="game-stats">
            <div id="stats-column">
                <div class="stat-row">
                    <div class="stat-label">计数:</div>
                    <div id="counter" class="stat-value">0</div>
                </div>
                <div class="stat-row">
                    <div class="stat-label">时间:</div>
                    <div id="timer" class="stat-value">15.000</div>
                </div>
            </div>
            <div class="buttons-row">
                <button class="virtual-btn" id="count-btn">计数</button>
                <button class="virtual-btn" id="enter-btn">提交</button>
            </div>
        </div>
        
        <div id="level-display" class="level-display">关卡: 1</div>
    </div>

    <script>
        // 游戏配置
        const config = {
            canvas: document.getElementById('game-canvas'),
            ctx: document.getElementById('game-canvas').getContext('2d'),
            counterDisplay: document.getElementById('counter'),
            timerDisplay: document.getElementById('timer'),
            startScreen: document.getElementById('start-screen'),
            winScreen: document.getElementById('win-screen'),
            loseScreen: document.getElementById('lose-screen'),
            winMessage: document.getElementById('win-message'),
            loseMessage: document.getElementById('lose-message'),
            recordMessage: document.getElementById('record-message'),
            startButton: document.getElementById('start-button'),
            nextLevelButton: document.getElementById('next-level-button'),
            restartButton: document.getElementById('restart-button'),
            levelDisplay: document.getElementById('level-display'),
            countBtn: document.getElementById('count-btn'),
            enterBtn: document.getElementById('enter-btn')
        };

        // 调整画布大小以适应屏幕
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            config.canvas.width = container.clientWidth;
            config.canvas.height = container.clientHeight - 120;
        }

        // 小鸟颜色选项
        const birdColors = ['#8B0000', '#FF8C00', '#00008B', '#2F4F4F', '#4B0082'];

        // 游戏状态
        let gameState = {
            level: 1,
            birdCount: 0,
            counter: 0,
            timer: 15,
            gameActive: false,
            birds: [],
            startTime: 0,
            elapsedTime: 0,
            highestLevel: localStorage.getItem('highestLevel') ? parseInt(localStorage.getItem('highestLevel')) : 0,
            newRecord: false
        };

        // 禁区定义（左下角区域）
        let forbiddenArea = {
            x: 0,
            y: 0,
            width: 0,
            height: 0
        };

        // 更新禁区位置
        function updateForbiddenArea() {
            forbiddenArea = {
                x: 0,
                y: config.canvas.height - 100,
                width: config.canvas.width,
                height: 100
            };
        }

        // 小鸟类
        class Bird {
            constructor(x, y, radius) {
                this.x = x;
                this.y = y;
                this.radius = radius;
                this.state = 'waiting';
                this.waitTime = Math.random() * 6000 + 2000; // 2-8秒
                this.moveTime = Math.random() * 1000 + 1000; // 1-2秒
                this.stateTimer = 0;
                this.direction = Math.random() * Math.PI * 2;
                this.speed = 0.5;
                this.wingPhase = 0;
                this.wingAngle = 0;
                this.color = birdColors[Math.floor(Math.random() * birdColors.length)];
            }

            update(deltaTime) {
                this.stateTimer += deltaTime;
                
                if (this.state === 'waiting') {
                    if (this.stateTimer >= this.waitTime) {
                        this.state = 'moving';
                        this.stateTimer = 0;
                        this.direction = Math.random() * Math.PI * 2;
                    }
                } else if (this.state === 'moving') {
                    // 更新翅膀动画
                    this.wingPhase = (this.wingPhase + 0.1) % (Math.PI * 2);
                    this.wingAngle = Math.sin(this.wingPhase) * 0.8;
                    
                    // 移动小鸟
                    this.x += Math.cos(this.direction) * this.speed;
                    this.y += Math.sin(this.direction) * this.speed;
                    
                    // 边界检测
                    if (this.x - this.radius < 0) {
                        this.x = this.radius;
                        this.direction = Math.PI - this.direction;
                    } else if (this.x + this.radius > config.canvas.width) {
                        this.x = config.canvas.width - this.radius;
                        this.direction = Math.PI - this.direction;
                    }
                    
                    if (this.y - this.radius < 0) {
                        this.y = this.radius;
                        this.direction = -this.direction;
                    } else if (this.y + this.radius > config.canvas.height) {
                        this.y = config.canvas.height - this.radius;
                        this.direction = -this.direction;
                    }
                    
                    // 禁区检测（左下角）
                    const buffer = 20;
                    if (this.x - this.radius < forbiddenArea.x + forbiddenArea.width + buffer && 
                        this.y + this.radius > forbiddenArea.y - buffer &&
                        this.x + this.radius > forbiddenArea.x - buffer &&
                        this.y - this.radius < forbiddenArea.y + forbiddenArea.height + buffer) {
                        
                        // 计算远离禁区中心的方向
                        const centerX = forbiddenArea.x + forbiddenArea.width / 2;
                        const centerY = forbiddenArea.y + forbiddenArea.height / 2;
                        const dx = this.x - centerX;
                        const dy = this.y - centerY;
                        this.direction = Math.atan2(dy, dx);
                    }
                    
                    // 检查是否应该切换回等待状态
                    if (this.stateTimer >= this.moveTime) {
                        this.state = 'waiting';
                        this.stateTimer = 0;
                        this.waitTime = Math.random() * 6000 + 2000;
                        this.wingAngle = 0;
                    }
                }
            }

            draw() {
                const ctx = config.ctx;
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.direction);
                
                // 身体（正圆）
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                
                // 翅膀（只在移动时绘制）
                if (this.state === 'moving') {
                    ctx.save();
                    ctx.rotate(this.wingAngle);
                    
                    // 左翅膀（尺寸增加10%）
                    ctx.beginPath();
                    ctx.moveTo(-this.radius * 0.6 * 1.1, 0);
                    ctx.bezierCurveTo(
                        -this.radius * 1.2 * 1.1, -this.radius * 0.5 * 1.1,
                        -this.radius * 1.5 * 1.1, -this.radius * 0.3 * 1.1,
                        -this.radius * 0.8 * 1.1, -this.radius * 0.8 * 1.1
                    );
                    ctx.bezierCurveTo(
                        -this.radius * 0.5 * 1.1, -this.radius * 1.0 * 1.1,
                        -this.radius * 0.3 * 1.1, -this.radius * 0.8 * 1.1,
                        -this.radius * 0.6 * 1.1, 0
                    );
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    
                    // 右翅膀（尺寸增加10%）
                    ctx.beginPath();
                    ctx.moveTo(-this.radius * 0.6 * 1.1, 0);
                    ctx.bezierCurveTo(
                        -this.radius * 1.2 * 1.1, this.radius * 0.5 * 1.1,
                        -this.radius * 1.5 * 1.1, this.radius * 0.3 * 1.1,
                        -this.radius * 0.8 * 1.1, this.radius * 0.8 * 1.1
                    );
                    ctx.bezierCurveTo(
                        -this.radius * 0.5 * 1.1, this.radius * 1.0 * 1.1,
                        -this.radius * 0.3 * 1.1, this.radius * 0.8 * 1.1,
                        -this.radius * 0.6 * 1.1, 0
                    );
                    ctx.fillStyle = this.color;
                    ctx.fill();
                    
                    ctx.restore();
                }
                
                // 头部（白色）
                ctx.beginPath();
                ctx.arc(this.radius * 0.3, 0, this.radius * 0.4, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                // 眼睛（大而可爱）
                ctx.beginPath();
                ctx.arc(this.radius * 0.4, -this.radius * 0.1, this.radius * 0.15, 0, Math.PI * 2);
                ctx.fillStyle = 'white';
                ctx.fill();
                
                ctx.beginPath();
                ctx.arc(this.radius * 0.42, -this.radius * 0.1, this.radius * 0.07, 0, Math.PI * 2);
                ctx.fillStyle = 'black';
                ctx.fill();
                
                // 嘴巴（橙色）
                ctx.beginPath();
                ctx.moveTo(this.radius * 0.5, 0);
                ctx.lineTo(this.radius * 0.8, this.radius * 0.1);
                ctx.lineTo(this.radius * 0.8, -this.radius * 0.1);
                ctx.closePath();
                ctx.fillStyle = '#FFA500';
                ctx.fill();
                
                ctx.restore();
            }
        }

        // 初始化游戏
        function initGame() {
            // 调整画布大小
            resizeCanvas();
            updateForbiddenArea();
            
            // 更新关卡显示
            config.levelDisplay.textContent = `关卡: ${gameState.level}`;
            
            // 根据关卡确定小鸟数量
            if (gameState.level === 1) {
                gameState.birdCount = Math.floor(Math.random() * 4) + 2; // 2-5
            } else if (gameState.level === 2) {
                gameState.birdCount = Math.floor(Math.random() * 5) + 6; // 6-10
            } else if (gameState.level === 3) {
                gameState.birdCount = Math.floor(Math.random() * 5) + 11; // 11-15
            } else if (gameState.level === 4) {
                gameState.birdCount = Math.floor(Math.random() * 10) + 16; // 16-25
            } else {
                // 第五关起：每关下限/上限增加2
                const base = 16 + (gameState.level - 4) * 2;
                gameState.birdCount = Math.floor(Math.random() * 10) + base;
            }
            
            // 重置计数器
            gameState.counter = 0;
            gameState.timer = 15;
            gameState.birds = [];
            gameState.gameActive = true;
            gameState.startTime = performance.now();
            gameState.elapsedTime = 0;
            gameState.newRecord = false;
            
            // 更新显示
            config.counterDisplay.textContent = gameState.counter;
            config.timerDisplay.textContent = '15.000';
            
            // 生成小鸟（确保不重叠）
            generateBirds();
            
            // 隐藏所有屏幕，显示游戏和虚拟键盘
            config.startScreen.classList.add('hidden');
            config.winScreen.classList.add('hidden');
            config.loseScreen.classList.add('hidden');
        }

        // 生成不重叠的小鸟
        function generateBirds() {
            const minDistance = 50;
            const maxAttempts = 100;
            
            for (let i = 0; i < gameState.birdCount; i++) {
                let birdCreated = false;
                let attempts = 0;
                
                while (!birdCreated && attempts < maxAttempts) {
                    attempts++;
                    
                    // 计算小鸟半径（数量越多，半径越小）
                    const baseRadius = Math.min(20, config.canvas.width * 0.05);
                    const minRadius = Math.max(8, config.canvas.width * 0.02);
                    const radius = Math.max(minRadius, baseRadius - (gameState.birdCount - 5) * 0.5);
                    
                    // 随机位置（避开禁区）
                    let x, y;
                    let validPosition = false;
                    
                    while (!validPosition) {
                        x = Math.random() * (config.canvas.width - radius * 2) + radius;
                        y = Math.random() * (config.canvas.height - radius * 2) + radius;
                        
                        // 检查是否在禁区
                        if (x + radius > forbiddenArea.x && 
                            x - radius < forbiddenArea.x + forbiddenArea.width &&
                            y + radius > forbiddenArea.y && 
                            y - radius < forbiddenArea.y + forbiddenArea.height) {
                            continue;
                        }
                        
                        // 检查是否与现有小鸟重叠
                        let overlap = false;
                        for (const bird of gameState.birds) {
                            const dx = bird.x - x;
                            const dy = bird.y - y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < minDistance) {
                                overlap = true;
                                break;
                            }
                        }
                        
                        if (!overlap) {
                            validPosition = true;
                        }
                    }
                    
                    // 创建小鸟
                    gameState.birds.push(new Bird(x, y, radius));
                    birdCreated = true;
                }
            }
        }

        // 游戏主循环
        function gameLoop() {
            // 清除画布
            config.ctx.clearRect(0, 0, config.canvas.width, config.canvas.height);
            
            // 绘制背景
            config.ctx.fillStyle = '#87CEEB';
            config.ctx.fillRect(0, 0, config.canvas.width, config.canvas.height);
            
            // 绘制云朵
            drawClouds();
            
            if (gameState.gameActive) {
                // 更新游戏状态
                const currentTime = performance.now();
                const deltaTime = currentTime - gameState.startTime - gameState.elapsedTime;
                gameState.elapsedTime = currentTime - gameState.startTime;
                
                // 更新倒计时
                updateTimer();
                
                // 更新小鸟
                for (const bird of gameState.birds) {
                    bird.update(deltaTime);
                    bird.draw();
                }
            }
            
            requestAnimationFrame(gameLoop);
        }

        // 绘制云朵
        function drawClouds() {
            const ctx = config.ctx;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
            
            // 云朵1
            ctx.beginPath();
            ctx.arc(config.canvas.width * 0.1, config.canvas.height * 0.1, 30, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.15, config.canvas.height * 0.08, 35, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.2, config.canvas.height * 0.1, 30, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.15, config.canvas.height * 0.12, 25, 0, Math.PI * 2);
            ctx.fill();
            
            // 云朵2
            ctx.beginPath();
            ctx.arc(config.canvas.width * 0.7, config.canvas.height * 0.15, 40, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.75, config.canvas.height * 0.12, 45, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.8, config.canvas.height * 0.15, 40, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.75, config.canvas.height * 0.17, 35, 0, Math.PI * 2);
            ctx.fill();
            
            // 云朵3
            ctx.beginPath();
            ctx.arc(config.canvas.width * 0.4, config.canvas.height * 0.25, 35, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.45, config.canvas.height * 0.22, 40, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.5, config.canvas.height * 0.25, 35, 0, Math.PI * 2);
            ctx.arc(config.canvas.width * 0.45, config.canvas.height * 0.27, 30, 0, Math.PI * 2);
            ctx.fill();
        }

        // 更新计时器
        function updateTimer() {
            const elapsed = performance.now() - gameState.startTime;
            const remainingTime = Math.max(0, 15000 - elapsed);
            
            // 更新显示
            const seconds = Math.floor(remainingTime / 1000);
            const milliseconds = Math.floor(remainingTime % 1000);
            config.timerDisplay.textContent = `${seconds}.${milliseconds.toString().padStart(3, '0')}`;
            
            // 检查是否超时
            if (remainingTime <= 0) {
                gameOver('timeout');
            }
        }

        // 处理键盘事件
        function handleKeyDown(e) {
            if (!gameState.gameActive) return;
            
            if (e.key === ' ' || e.key === 'Spacebar') {
                incrementCounter();
                e.preventDefault();
            } else if (e.key === 'Enter') {
                checkAnswer();
            }
        }

        // 增加计数
        function incrementCounter() {
            if (!gameState.gameActive) return;
            
            gameState.counter++;
            config.counterDisplay.textContent = gameState.counter;
        }

        // 检查答案
        function checkAnswer() {
            if (!gameState.gameActive) return;
            
            gameState.gameActive = false;
            
            if (gameState.counter === gameState.birdCount) {
                // 胜利
                const timeUsed = (performance.now() - gameState.startTime) / 1000;
                config.winMessage.innerHTML = 
                    `您的用时: <b>${timeUsed.toFixed(3)}秒</b><br>
                     小鸟数量: <b>${gameState.birdCount}</b><br>
                     您的计数: <b>${gameState.counter}</b>`;
                config.winScreen.classList.remove('hidden');
                
                // 更新关卡
                gameState.level++;
                
                // 检查是否破纪录
                if (gameState.level > gameState.highestLevel) {
                    gameState.highestLevel = gameState.level;
                    gameState.newRecord = true;
                    localStorage.setItem('highestLevel', gameState.highestLevel);
                }
            } else {
                // 失败
                gameOver('wrong');
            }
        }

        // 游戏结束
        function gameOver(reason) {
            gameState.gameActive = false;
            
            if (reason === 'timeout') {
                config.loseMessage.innerHTML = 
                    `您已超时！<br>
                     小鸟数量: <b>${gameState.birdCount}</b><br>
                     您的闯关数: <b>${gameState.level}</b>`;
            } else {
                config.loseMessage.innerHTML = 
                    `计数错误！<br>
                     小鸟数量: <b>${gameState.birdCount}</b><br>
                     您的计数: <b>${gameState.counter}</b><br>
                     您的闯关数: <b>${gameState.level}</b>`;
            }
            
            // 检查是否破纪录
            if (gameState.level > gameState.highestLevel) {
                gameState.highestLevel = gameState.level;
                gameState.newRecord = true;
                localStorage.setItem('highestLevel', gameState.highestLevel);
            }
            
            // 显示历史最高记录
            config.recordMessage.innerHTML = `历史最高闯关数: <b>${gameState.highestLevel}</b>`;
            
            if (gameState.newRecord) {
                const recordBadge = document.createElement('div');
                recordBadge.className = 'record-badge';
                recordBadge.textContent = '破纪录了！';
                config.loseScreen.appendChild(recordBadge);
            }
            
            config.loseScreen.classList.remove('hidden');
        }

        // 事件监听器
        config.startButton.addEventListener('click', () => {
            gameState.level = 1;
            initGame();
        });

        config.nextLevelButton.addEventListener('click', () => {
            initGame();
        });

        config.restartButton.addEventListener('click', () => {
            gameState.level = 1;
            initGame();
        });

        // 虚拟按钮事件
        config.countBtn.addEventListener('click', incrementCounter);
        config.enterBtn.addEventListener('click', checkAnswer);
        
        // 物理键盘事件
        window.addEventListener('keydown', handleKeyDown);
        
        // 窗口大小变化时调整画布
        window.addEventListener('resize', () => {
            resizeCanvas();
            updateForbiddenArea();
        });

        // 启动游戏循环
        resizeCanvas();
        updateForbiddenArea();
        gameLoop();
    </script>
</body>
</html>